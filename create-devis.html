<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Créer un devis</title>
    <link rel="stylesheet" href="wizard-style.css">
</head>
<body>
    <div class="wizard-app">
        <!-- Header -->
        <div class="wizard-header">
            <button class="close-btn" onclick="window.location.href='dashboard.html'">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
            
            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text" id="progressText">1/3</div>
            </div>
        </div>

        <!-- Step 1: Select Client -->
        <div class="wizard-step" id="step1">
            <h1 class="wizard-title">Sélectionnez un client</h1>
            
            <div class="wizard-content">
                <button class="create-client-btn" id="createClientBtn">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 5V19M5 12H19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <span>Créer un client</span>
                </button>
                
                <div class="clients-list" id="clientsList">
                    <!-- Les clients seront chargés ici dynamiquement -->
                </div>
            </div>
        </div>

        <!-- Step 2: Add Items -->
        <div class="wizard-step hidden" id="step2">
            <h1 class="wizard-title">Ajoutez des articles</h1>
            
            <div class="wizard-content">
                <div class="selected-client-info" id="selectedClientInfo">
                    <!-- Info client sélectionné -->
                </div>
                
                <button class="add-item-btn" id="addItemBtn">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 5V19M5 12H19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <span>Ajouter un article</span>
                </button>
                
                <div class="items-list" id="itemsList">
                    <!-- Les articles seront ajoutés ici -->
                </div>
                
                <div class="total-section">
                    <div class="total-row">
                        <span>Total HT</span>
                        <span id="totalHT">0,00 €</span>
                    </div>
                    <div class="total-row">
                        <span>TVA (20%)</span>
                        <span id="totalTVA">0,00 €</span>
                    </div>
                    <div class="total-row total-final">
                        <span>Total TTC</span>
                        <span id="totalTTC">0,00 €</span>
                    </div>
                </div>
            </div>
            
            <div class="wizard-footer">
                <button class="btn-secondary" id="backToStep1">Retour</button>
                <button class="btn-primary" id="nextToStep3">Suivant</button>
            </div>
        </div>

        <!-- Step 3: Review and Generate -->
        <div class="wizard-step hidden" id="step3">
            <h1 class="wizard-title">Valider et générer</h1>
            
            <div class="wizard-content">
                <div class="review-section">
                    <h3>Informations du devis</h3>
                    
                    <div class="form-group">
                        <label for="devisDate">Date du devis</label>
                        <input type="date" id="devisDate" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="validityDate">Date de validité</label>
                        <input type="date" id="validityDate" readonly style="background: #F5F5F5; cursor: not-allowed;">
                        <small>Automatiquement fixée à 30 jours après la date du devis</small>
                    </div>
                    
                    <div class="form-group">
                        <label>Acompte à la commande</label>
                        <div style="display: flex; align-items: center; gap: 15px; margin-top: 10px;">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" id="acompteCheck" style="width: 20px; height: 20px; cursor: pointer;">
                                <span>Demander un acompte</span>
                            </label>
                            <div id="acompteInputWrapper" style="display: none; flex: 1;">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <input type="number" id="acomptePercent" min="1" max="100" value="30" style="width: 80px; padding: 8px; border: 1px solid #E0E0E0; border-radius: 8px;">
                                    <span>%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="notes">Notes / Conditions</label>
                        <textarea id="notes" rows="4" placeholder="Conditions de paiement, délais, etc."></textarea>
                    </div>
                </div>
                
                <div class="review-summary" id="reviewSummary">
                    <!-- Résumé du devis -->
                </div>
            </div>
            
            <div class="wizard-footer">
                <button class="btn-secondary" id="backToStep2">Retour</button>
                <button class="btn-primary" id="generateDevis">Générer le devis</button>
            </div>
        </div>
    </div>

    <!-- Modal Create Client -->
    <div class="modal hidden" id="createClientModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Nouveau client</h2>
                <button class="modal-close" id="closeClientModal">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
            </div>
            
            <form id="createClientForm">
                <div class="form-group">
                    <label>Type de client *</label>
                    <div class="client-type-selector">
                        <label class="radio-option">
                            <input type="radio" name="clientType" value="particulier" checked>
                            <span class="radio-label">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M20 21V19C20 17.9391 19.5786 16.9217 18.8284 16.1716C18.0783 15.4214 17.0609 15 16 15H8C6.93913 15 5.92172 15.4214 5.17157 16.1716C4.42143 16.9217 4 17.9391 4 19V21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <circle cx="12" cy="7" r="4" stroke="currentColor" stroke-width="2"/>
                                </svg>
                                Particulier
                            </span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="clientType" value="entreprise">
                            <span class="radio-label">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <rect x="3" y="3" width="18" height="18" rx="2" stroke="currentColor" stroke-width="2"/>
                                    <path d="M9 3V21M15 3V21M3 9H21M3 15H21" stroke="currentColor" stroke-width="2"/>
                                </svg>
                                Entreprise
                            </span>
                        </label>
                    </div>
                </div>
                
                <!-- Formulaire Particulier -->
                <div id="particulierFields">
                    <div class="form-section">
                        <h4>Informations personnelles</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="particNom">Nom *</label>
                                <input type="text" id="particNom" required placeholder="Dupont">
                            </div>
                            <div class="form-group">
                                <label for="particPrenom">Prénom *</label>
                                <input type="text" id="particPrenom" required placeholder="Jean">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h4>Contact</h4>
                        <div class="form-group">
                            <label for="particEmail">Adresse email *</label>
                            <input type="email" id="particEmail" required placeholder="jean.dupont@email.com">
                        </div>
                        <div class="form-group">
                            <label for="particTel">Numéro de téléphone *</label>
                            <input type="tel" id="particTel" required placeholder="+33 6 12 34 56 78">
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h4>Adresse</h4>
                        <div class="form-group">
                            <label for="particAdresse">Adresse *</label>
                            <input type="text" id="particAdresse" required placeholder="123 Rue de la Paix">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="particCodePostal">Code postal *</label>
                                <input type="text" id="particCodePostal" required placeholder="75001">
                            </div>
                            <div class="form-group">
                                <label for="particVille">Ville *</label>
                                <input type="text" id="particVille" required placeholder="Paris">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="particPays">Pays *</label>
                            <input type="text" id="particPays" required placeholder="France" value="France">
                        </div>
                    </div>
                </div>
                
                <!-- Formulaire Entreprise -->
                <div id="entrepriseFields" style="display: none;">
                    <div class="form-section">
                        <h4>Informations entreprise</h4>
                        <div class="form-group">
                            <label for="entSiren">SIREN *</label>
                            <input type="text" id="entSiren" placeholder="123456789" maxlength="9">
                            <small class="input-help">✨ Tapez 9 chiffres - Complétion automatique</small>
                        </div>
                        <div id="sirenLoading" class="siren-loading" style="display: none;">
                            <div class="loading-spinner"></div>
                            <span>Recherche en cours...</span>
                        </div>
                        <div class="form-group">
                            <label for="entNom">Nom de l'entreprise *</label>
                            <input type="text" id="entNom" placeholder="SARL Dupont">
                        </div>
                        <div class="form-group">
                            <label for="entTVA">Numéro de TVA *</label>
                            <input type="text" id="entTVA" placeholder="FR 12 345678901">
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h4>Contact</h4>
                        <div class="form-group">
                            <label for="entEmail">Adresse email *</label>
                            <input type="email" id="entEmail" placeholder="contact@entreprise.com">
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h4>Adresse</h4>
                        <div class="form-group">
                            <label for="entAdresse">Adresse *</label>
                            <input type="text" id="entAdresse" placeholder="123 Avenue des Entreprises">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="entCodePostal">Code postal *</label>
                                <input type="text" id="entCodePostal" placeholder="75001">
                            </div>
                            <div class="form-group">
                                <label for="entVille">Ville *</label>
                                <input type="text" id="entVille" placeholder="Paris">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="entPays">Pays *</label>
                            <input type="text" id="entPays" placeholder="France" value="France">
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h4>Contact dédié</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="entContactPrenom">Prénom *</label>
                                <input type="text" id="entContactPrenom" placeholder="Jean">
                            </div>
                            <div class="form-group">
                                <label for="entContactNom">Nom *</label>
                                <input type="text" id="entContactNom" placeholder="Dupont">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="entContactTel">Téléphone *</label>
                            <input type="tel" id="entContactTel" placeholder="+33 6 12 34 56 78">
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" id="cancelClient">Annuler</button>
                    <button type="submit" class="btn-primary">Créer</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Select/Add Item -->
    <div class="modal hidden" id="addItemModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Sélectionner un article</h2>
                <button class="modal-close" id="closeItemModal">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
            </div>
            
            <!-- Liste des articles -->
            <div id="itemsListModal" class="items-modal-list">
                <button class="create-item-btn" id="createNewItemBtn">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 5V19M5 12H19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <span>Créer un nouvel article</span>
                </button>
                
                <div class="saved-items-list" id="savedItemsList">
                    <!-- Les articles sauvegardés seront chargés ici -->
                </div>
            </div>
            
            <!-- Formulaire de quantité (affiché après sélection d'un article) -->
            <div id="quantityForm" class="quantity-form hidden">
                <div class="selected-item-display" id="selectedItemDisplay"></div>
                
                <div class="form-group">
                    <label for="itemQuantitySelect">Quantité *</label>
                    <input type="number" id="itemQuantitySelect" min="1" value="1" required>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" id="backToItemsList">Retour</button>
                    <button type="button" class="btn-primary" id="addSelectedItem">Ajouter au devis</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Create New Item -->
    <div class="modal hidden" id="createItemModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Créer un article</h2>
                <button class="modal-close" id="closeCreateItemModal">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
            </div>
            
            <form id="createItemForm">
                <div class="form-group">
                    <label for="newItemTitle">Titre *</label>
                    <input type="text" id="newItemTitle" required placeholder="Ex: Prestation développement">
                </div>
                
                <div class="form-group">
                    <label for="newItemDescription">Courte description *</label>
                    <input type="text" id="newItemDescription" required placeholder="Ex: Développement web sur mesure">
                </div>
                
                <div class="form-group">
                    <label for="newItemPrice">Prix unitaire HT (€) *</label>
                    <input type="number" id="newItemPrice" step="0.01" min="0" required placeholder="0.00">
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" id="cancelCreateItem">Annuler</button>
                    <button type="submit" class="btn-primary">Sauvegarder</button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script type="module" src="firebase-config.js"></script>
    <script type="module" src="create-devis.js"></script>
</body>
</html>
